name: PushPlus å®šæ—¶é€šçŸ¥

on:
  schedule:
    # æ¯ 30 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¾…å‘é€ä»»åŠ¡
    - cron: '*/30 * * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:

jobs:
  send-notification:
    runs-on: ubuntu-latest

    # è®© GITHUB_TOKEN æ‹¥æœ‰å†™æƒé™ï¼Œä»¥ä¾¿ git push
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Send PushPlus notifications
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          REMINDER_FILE_PATH: data/reminders.json
          REMINDER_TIMEZONE_OFFSET: '8'
        run: python scripts/pushplus_notify.py

      - name: Commit & push reminder status updates
        if: always()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/reminders.json
          # å¦‚æžœæ²¡æœ‰å˜æ›´å°±è·³è¿‡æäº¤
          git diff --cached --quiet && echo "ðŸ“­ æ— çŠ¶æ€å˜æ›´ï¼Œè·³è¿‡æäº¤" && exit 0
          git commit -m "chore: update reminder statuses [skip ci]"
          git push

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ“¨ PushPlus é€šçŸ¥ä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
